<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>企業データ 散布図</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    #plot {
      width: 100%;
      height: 70vh;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="text-center mb-4">企業データ 散布図</h1>

    <div class="card p-3 mb-4 shadow-sm">
      <div class="mb-3">
        <label for="search-input" class="form-label">企業名検索（全角・半角対応）</label>
        <input type="text" class="form-control" id="search-input" placeholder="企業名を入力">
      </div>

      <div class="row gy-2 gx-3 align-items-center">
        <div class="col-md-6">
          <label for="y-select" class="form-label">縦軸</label>
          <div class="input-group">
            <select id="y-select" class="form-select">
              {% for col in axis_options %}
                <option value="{{ col }}" {% if col == "売上高" %}selected{% endif %}>{{ col }}</option>
              {% endfor %}
            </select>
            <div class="input-group-text">
              <input class="form-check-input mt-0" type="checkbox" id="y-log">
              <label for="y-log" class="ms-2 mb-0">対数軸</label>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <label for="x-select" class="form-label">横軸</label>
          <div class="input-group">
            <select id="x-select" class="form-select">
              {% for col in axis_options %}
                <option value="{{ col }}" {% if col == "営業利益" %}selected{% endif %}>{{ col }}</option>
              {% endfor %}
            </select>
            <div class="input-group-text">
              <input class="form-check-input mt-0" type="checkbox" id="x-log">
              <label for="x-log" class="ms-2 mb-0">対数軸</label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="plot" class="bg-white rounded shadow-sm"></div>
  </div>

  <script>
    const plotData = {{ data_json | safe }};
    const xSelect = document.getElementById('x-select');
    const ySelect = document.getElementById('y-select');
    const searchInput = document.getElementById('search-input');
    const plotDiv = document.getElementById('plot');
    const xLogCheckbox = document.getElementById("x-log");
    const yLogCheckbox = document.getElementById("y-log");

    function normalize(text) {
      return text.replace(/\s+/g, "").toLowerCase()
                 .replace(/[Ａ-Ｚａ-ｚ０-９]/g, s =>
                   String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
    }

    function formatValue(key, value) {
      if (key.includes("率") || key === "ROE" || key === "ROA") {
        return `${value.toFixed(1)}%`;
      }
      if (Math.abs(value) >= 1e12) return (value / 1e12).toFixed(1) + "兆円";
      if (Math.abs(value) >= 1e8) return (value / 1e8).toFixed(1) + "億円";
      return value.toLocaleString();
    }

    function drawChart(xKey, yKey, keyword = "") {
      const normKeyword = normalize(keyword);
      const xAll = [], yAll = [], textAll = [], xMatched = [], yMatched = [], textMatched = [];

      for (const d of plotData) {
        const xVal = Number(d[xKey]);
        const yVal = Number(d[yKey]);
        if (!isFinite(xVal) || !isFinite(yVal)) continue;
        if (xKey.includes("率") && (xVal < -100 || xVal > 100)) continue;
        if (yKey.includes("率") && (yVal < -100 || yVal > 100)) continue;

        const company = d["企業名"] || "";
        const hover = `${company}<br>${yKey}: ${formatValue(yKey, yVal)}<br>${xKey}: ${formatValue(xKey, xVal)}`;
        const isMatch = normKeyword && normalize(company).includes(normKeyword);

        if (isMatch) {
          xMatched.push(xVal);
          yMatched.push(yVal);
          textMatched.push(hover);
        } else {
          xAll.push(xVal);
          yAll.push(yVal);
          textAll.push(hover);
        }
      }

      const traceUnmatched = {
        x: xAll,
        y: yAll,
        text: textAll,
        mode: 'markers',
        marker: { size: 5, color: 'black' },
        type: 'scatter',
        name: '企業'
      };

      const traceMatched = {
        x: xMatched,
        y: yMatched,
        text: textMatched,
        mode: 'markers',
        marker: { size: 7, color: 'red', line: { width: 2, color: '#fffffe' } },
        type: 'scatter',
        name: '検索結果'
      };

      const layout = {
        title: `${yKey} vs ${xKey}`,
        xaxis: { title: xKey, type: xLogCheckbox.checked ? "log" : "linear" },
        yaxis: { title: yKey, type: yLogCheckbox.checked ? "log" : "linear" },
        hovermode: 'closest',
        autosize: true,
        dragmode: 'pan'
      };

      Plotly.newPlot(plotDiv, [traceUnmatched, traceMatched], layout, {
        responsive: true,
        scrollZoom: true
      }).then(() => {
        Plotly.moveTraces(plotDiv, -1, 1);
      });
    }

    [xSelect, ySelect, searchInput, xLogCheckbox, yLogCheckbox].forEach(el =>
      el.addEventListener("input", () => {
        drawChart(xSelect.value, ySelect.value, searchInput.value);
      })
    );

    drawChart(xSelect.value, ySelect.value);
  </script>
</body>
</html>
